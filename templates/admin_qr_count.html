{% extends 'base.html' %}
{% block content %}

<style>
  /* Rounded table */
  #attendanceTable {
    border-radius: 12px;
    overflow: hidden;
  }

  #attendanceTable thead {
    background: #1e3a8a;
    color: white;
  }

  #attendanceTable tbody tr:hover {
    background: #eef2ff;
    transition: 0.2s;
  }

  /* Refresh text effect */
  #refreshStatus {
    font-size: 0.85rem;
    color: #555;
    margin-bottom: 8px;
    display: none;
  }
</style>

<div class="container mt-4">

  <h2 class="mb-3 text-center fw-bold">ðŸ“Š Daily Meal Attendance</h2>

  <!-- Refresh Status -->
  <div id="refreshStatus" class="text-center">Refreshingâ€¦</div>

  <!-- Month Filter -->
  <div class="mb-3 text-center">
    <label for="monthFilter" class="form-label fw-semibold">Filter by Month:</label>
    <select id="monthFilter" class="form-select d-inline-block w-auto ms-2">
      <option value="all">All</option>
      {% for month in months %}
      <option value="{{ month.value }}">{{ month.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Historical Counts Table -->
  <div class="table-responsive">
    <table class="table table-bordered text-center" id="attendanceTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Breakfast</th>
          <th>Lunch</th>
          <th>Snacks</th>   <!-- â­ NEW -->
          <th>Dinner</th>
        </tr>
      </thead>
      <tbody>
        {% for row in counts_by_date %}
        <tr data-month="{{ row.month_key }}">
          <td class="fw-semibold">{{ row.date }}</td>
          <td>{{ row.meals.breakfast }}</td>
          <td>{{ row.meals.lunch }}</td>
          <td>{{ row.meals.snacks }}</td>   <!-- â­ NEW -->
          <td>{{ row.meals.dinner }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Auto refresh + month filter -->
<script>
  const monthFilter = document.getElementById('monthFilter');
  const rows = document.querySelectorAll('#attendanceTable tbody tr');
  const refreshStatus = document.getElementById('refreshStatus');

  monthFilter.addEventListener('change', () => {
    const selected = monthFilter.value;
    rows.forEach(row => {
      const month = row.getAttribute('data-month');
      row.style.display = (selected === 'all' || month === selected) ? '' : 'none';
    });
  });

  // Auto refresh every 2 minutes
  function autoRefresh() {
    refreshStatus.style.display = "block";
    refreshStatus.innerText = "Refreshingâ€¦";

    fetch("/admin/qr_scan_counts_json")
      .then(res => res.json())
      .then(data => {
        refreshStatus.innerText = "Updated âœ”";
        setTimeout(() => { refreshStatus.style.display = "none"; }, 1500);

        // Update table dynamically
        data.forEach(update => {
          const row = document.querySelector(`tr[data-month="${update.month_key}"][data-date="${update.date}"]`);
        });
      })
      .catch(() => {
        refreshStatus.innerText = "Failed to refresh âŒ";
        setTimeout(() => { refreshStatus.style.display = "none"; }, 2000);
      });
  }

  setInterval(autoRefresh, 120000); // 2 min
</script>

{% endblock %}
