{% extends "base.html" %}
{% block content %}

<style>
    /* Search bar */
    #searchInput {
        max-width: 350px;
        margin: 0 auto 15px;
        border-radius: 10px;
    }

    /* Success badge */
    #successMessage {
        display: none;
        background: #28a745;
        color: #fff;
        padding: 8px 14px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
        font-weight: 600;
        box-shadow: var(--shadow);
    }

    /* Rounded table container */
    .table-rounded {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-light);
    }

    /* Rounded cells */
    table.table tbody tr td,
    table.table thead th {
        vertical-align: middle;
        padding: 12px;
        border-color: var(--border-light);
    }

    /* Header */
    table thead tr {
        background: var(--primary) !important;
        color: #fff;
    }

    /* Row hover effect */
    table tbody tr:hover {
        background: #f5f7fb;
        transition: 0.2s;
    }

    /* Fine input */
    .fine-input {
        border-radius: 8px;
    }

    /* Small screens */
    @media (max-width:768px){
        table td { font-size: 0.9rem; }
        .fine-input { width: 90px !important; }
    }
</style>

<h3 class="fw-bold mb-3">User Fines Summary</h3>

<!-- Search -->
<input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Search by name or course">

<!-- Success message -->
<div id="successMessage"></div>

<!-- Table -->
<div class="table-responsive mt-3 table-rounded">
    <table class="table table-striped" id="finesTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Course</th>
                <th>Total Fines</th>
                <th style="width:180px;">Add Fine</th>
            </tr>
        </thead>

        <tbody>
            {% for u in users %}
            <tr data-user-id="{{ u.id }}">
                <td class="user-name fw-semibold">{{ u.name }}</td>
                <td class="user-course">{{ u.course }}</td>
                <td class="total-fines fw-bold text-primary">â‚¹{{ u.total_fines }}</td>

                <td>
                    <div class="d-flex gap-2">
                        <input type="number"
                               class="form-control fine-input"
                               placeholder="Amount"
                               min="1"
                               step="0.01">

                        <button class="btn btn-primary btn-sm rounded-pill addFineBtn">
                            Add
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<script>
// ---------------- LIVE SEARCH ----------------
document.getElementById("searchInput").addEventListener("keyup", () => {
    let q = searchInput.value.toLowerCase();

    document.querySelectorAll("#finesTable tbody tr").forEach(row => {
        let name = row.querySelector(".user-name").innerText.toLowerCase();
        let course = row.querySelector(".user-course").innerText.toLowerCase();

        row.style.display = (name.includes(q) || course.includes(q)) ? "" : "none";
    });
});


// ---------------- AJAX ADD FINE ----------------
document.querySelectorAll(".addFineBtn").forEach(btn => {
    btn.addEventListener("click", async function () {

        let row = this.closest("tr");
        let userId = row.dataset.userId;
        let input = row.querySelector(".fine-input");
        let fineAmount = input.value;

        if (!fineAmount || fineAmount <= 0){
            alert("Enter a valid fine amount");
            return;
        }

        let res = await fetch("{{ url_for('admin_user_fines') }}", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({
                user_id: userId,
                fine_amount: fineAmount
            })
        });

        let data = await res.json();

        if (data.success){
            // Update UI total
            row.querySelector(".total-fines").innerHTML = "â‚¹" + data.new_total;

            // Clear input
            input.value = "";

            // Show success popup
            let msg = document.getElementById("successMessage");
            msg.innerText = data.message;
            msg.style.display = "block";

            setTimeout(() => msg.style.display = "none", 2000);

        } else {
            alert("Error: " + data.message);
        }
    });
});
</script>

{% endblock %}
