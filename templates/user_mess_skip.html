{% extends "base.html" %}
{% block content %}

<!-- FLASH MESSAGE (shows on same page) -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} text-center fw-bold rounded-3 mt-3">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="container my-4" style="max-width: 700px;">

    <div class="card shadow-lg border-0 rounded-4 mb-5 theme-card">
        <div class="card-header text-center rounded-top-4 theme-card-header">
            <h3 class="mb-0 fw-bold" style="color: var(--primary);">
                <i class="fas fa-ban me-2"></i> Apply Mess Skip
            </h3>
        </div>
        <div class="card-body p-4 p-md-5">
            <form method="POST">
                <div class="mb-4">
                    <label for="skip_date" class="form-label fw-bold" style="color: var(--primary);">
                        <i class="fas fa-calendar-alt me-1"></i> Date of Skip:
                    </label>
                    <input type="date"
                            name="skip_date"
                            id="skip_date"
                            required
                            class="form-control form-control-lg rounded-3 shadow-sm theme-input"
                            onkeydown="return false;">
                    <small class="form-text text-muted">
                        *Skips must be requested at least one day in advance (before 10 PM).
                    </small>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold" style="color: var(--primary);">
                        <i class="fas fa-utensils me-1"></i> Meals to Skip:
                    </label>
                    <div class="d-flex flex-wrap justify-content-center justify-content-md-start gap-4 mt-2">
                        {% for meal, icon in [('breakfast', 'üç≥'), ('lunch', 'üçõ'), ('dinner', 'üç≤'), ('snacks', '‚òï')] %}
                        <div class="form-check form-switch form-check-lg">
                            <input class="form-check-input theme-switch" type="checkbox" name="{{ meal }}" id="{{ meal }}">
                            <label class="form-check-label fw-medium" for="{{ meal }}">
                                {{ icon }} {{ meal|capitalize }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-lg w-75 rounded-pill shadow-lg theme-submit-btn">
                        <i class="fas fa-check me-2"></i> Confirm Skip
                    </button>
                </div>
            </form>
        </div>
    </div>

    <h4 class="fw-bold text-center mb-4" style="color: var(--primary);">
        <i class="fas fa-clipboard-list me-2"></i> My Recent Mess Skips
    </h4>
    {% if skips %}
        <ul class="list-group shadow-sm rounded-3">
            {% for s in skips %}
                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap theme-list-item">
                    <div class="py-1">
                        <strong style="color: var(--text-color);">{{ s.skip_date }}</strong><br>
                        <small class="text-muted">
                            <i class="fas fa-utensils me-1" style="color: var(--primary);"></i> {{ s.meal_type|capitalize }}
                        </small>
                    </div>
                    <span class="badge rounded-pill fw-medium bg-primary text-white">SKIP APPLIED</span>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="alert text-center rounded-3" style="background-color: var(--sidebar-hover); color: var(--text-color);">
            <i class="fas a-mug-hot me-1" style="color: var(--primary);"></i> You haven‚Äôt applied for any mess skips yet. Ready to save?
        </div>
    {% endif %}

</div>

<style>
.theme-card { border: 1px solid var(--border-light) !important; }
.theme-card-header { background-color: var(--sidebar-hover) !important; padding: 1.25rem 1.5rem; }
.theme-input { border-color: var(--border-light); transition: 0.3s; }
.theme-input:focus { border-color: var(--primary); box-shadow: 0 0 0 0.25rem rgba(44,62,80,0.25); }
.form-check-lg { min-height: 1.5rem; }
.theme-switch { width: 2.5em; height: 1.5em; cursor: pointer; background-color: var(--border-light); }
.theme-switch:checked { background-color: var(--primary); border-color: var(--primary); }
.theme-switch:focus { box-shadow: 0 0 0 0.25rem rgba(44,62,80,0.25); }
.theme-submit-btn { background-color: var(--primary); border-color: var(--primary); color: white; font-weight: 600; transition: 0.3s; }
.theme-submit-btn:hover { background-color: #34495E; border-color: #34495E; transform: translateY(-2px); }
.theme-list-item { background-color: var(--card-bg); border-left: 5px solid var(--primary); margin-bottom: 8px; border-radius: var(--radius) !important; }
.list-group-item { border-color: var(--border-light); }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById("skip_date");
    const now = new Date();
    const deadlineToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 22, 0, 0);
    let minDate;

    if (now < deadlineToday) {
        minDate = new Date(now.setDate(now.getDate() + 1));
    } else {
        minDate = new Date(now.setDate(now.getDate() + 2));
    }

    dateInput.setAttribute("min", minDate.toISOString().split("T")[0]);
    dateInput.addEventListener("keydown", e => e.preventDefault());
});
</script>

<!-- üî• Disable Skips If Mess Cut Exists -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById("skip_date");
    const mealSwitches = document.querySelectorAll(".theme-switch");
    const submitBtn = document.querySelector(".theme-submit-btn");

    dateInput.addEventListener("change", function() {
        const selectedDate = this.value;
        if (!selectedDate) return;

        fetch(`/check_mess_cut?date=${selectedDate}`)
        .then(res => res.json())
        .then(data => {
            if (data.exists) {
                mealSwitches.forEach(m => m.disabled = true);
                submitBtn.disabled = true;
                alert("‚ö† Full day mess cut already applied for this date. Skips not allowed.");
            } else {
                mealSwitches.forEach(m => m.disabled = false);
                submitBtn.disabled = false;
            }
        });
    });
});
</script>

{% endblock %}
